version: '3.8'

services:
  # Spark Master
  spark-master:
    image: apache/spark:3.5.0
    container_name: spark-master
    hostname: spark-master
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=spark-master
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=9080
    ports:
      - "9080:9080"   # Master Web UI
      - "7077:7077"   # Master port
      - "4040:4040"   # Application UI
    volumes:
      - ./docker/spark-cluster/apps:/opt/spark-apps
      - ./docker/spark-cluster/data:/opt/spark-data
    networks:
      - spark-network
    command: >
      /bin/bash -c "
      /opt/spark/sbin/start-master.sh && 
      tail -f /opt/spark/logs/*
      "

  # Spark Worker 1
  spark-worker-1:
    image: apache/spark:3.5.0
    container_name: spark-worker-1
    hostname: spark-worker-1
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_PORT=8881
      - SPARK_WORKER_WEBUI_PORT=8081
    ports:
      - "8081:8081"
    volumes:
      - ./docker/spark-cluster/apps:/opt/spark-apps
      - ./docker/spark-cluster/data:/opt/spark-data
    networks:
      - spark-network
    command: >
      /bin/bash -c "
      /opt/spark/sbin/start-worker.sh spark://spark-master:7077 && 
      tail -f /opt/spark/logs/*
      "

  # Spark Worker 2
  spark-worker-2:
    image: apache/spark:3.5.0
    container_name: spark-worker-2
    hostname: spark-worker-2
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_PORT=8882
      - SPARK_WORKER_WEBUI_PORT=8082
    ports:
      - "8082:8082"
    volumes:
      - ./docker/spark-cluster/apps:/opt/spark-apps
      - ./docker/spark-cluster/data:/opt/spark-data
    networks:
      - spark-network
    command: >
      /bin/bash -c "
      /opt/spark/sbin/start-worker.sh spark://spark-master:7077 && 
      tail -f /opt/spark/logs/*
      "

  # Spark Worker 3
  spark-worker-3:
    image: apache/spark:3.5.0
    container_name: spark-worker-3
    hostname: spark-worker-3
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_PORT=8883
      - SPARK_WORKER_WEBUI_PORT=8083
    ports:
      - "8083:8083"
    volumes:
      - ./docker/spark-cluster/apps:/opt/spark-apps
      - ./docker/spark-cluster/data:/opt/spark-data
    networks:
      - spark-network
    command: >
      /bin/bash -c "
      /opt/spark/sbin/start-worker.sh spark://spark-master:7077 && 
      tail -f /opt/spark/logs/*
      "

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    hostname: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./src/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - spark-network
    depends_on:
      - spark-master

  # Monitoring Dashboard
  monitoring-dashboard:
    build:
      context: ./src/monitoring_frontend
      dockerfile: Dockerfile
    container_name: pyspark-monitoring-dashboard
    hostname: monitoring-dashboard
    ports:
      - "3000:3000"
    environment:
      # Internal URLs for server-side API routes (used by Next.js API routes)
      - SPARK_MASTER_INTERNAL_URL=http://spark-master:9080
      - SPARK_APP_INTERNAL_URL=http://spark-master:4040
      - PROMETHEUS_INTERNAL_URL=http://prometheus:9090
      # Public URLs (not used anymore due to CORS, but kept for reference)
      - NEXT_PUBLIC_SPARK_MASTER_URL=http://localhost:9080
      - NEXT_PUBLIC_SPARK_APP_URL=http://localhost:4040
      - NEXT_PUBLIC_PROMETHEUS_URL=http://localhost:9090
    networks:
      - spark-network
    depends_on:
      - spark-master
      - prometheus

networks:
  spark-network:
    driver: bridge

volumes:
  prometheus-data:
